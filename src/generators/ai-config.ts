/**
 * NEXUS CLI - AI Config Generator
 *
 * Generates AI agent instruction files for every major coding assistant.
 *
 * Strategy:
 *   The master file lives in `.nexus/ai/instructions.md` â€” a single folder
 *   that beginners can understand ("this is for AI tools").
 *
 *   EVERY tool-specific config file gets the FULL project-aware instructions
 *   embedded directly. We do NOT rely on "go read another file" directives
 *   because AI tools ignore cross-file pointers too often.
 *
 *   Files generated:
 *     .nexus/ai/instructions.md       â€” master file (full content)
 *     .cursorrules                     â€” Cursor (full content)
 *     .windsurfrules                   â€” Windsurf (full content)
 *     .clinerules                      â€” Cline (full content)
 *     AGENTS.md                        â€” Claude Code / OpenAI Codex (full content)
 *     .github/copilot-instructions.md  â€” GitHub Copilot (full content)
 *
 *   Every file is project-aware â€” it references the actual framework, data
 *   strategy, test framework, and patterns chosen during `nexus init`.
 *   Every file includes the onboarding protocol that tells the AI to
 *   populate template docs BEFORE doing anything the user asks.
 */

import type { NexusConfig } from '../types/config.js';
import type { GeneratedFile } from '../types/templates.js';
import { version } from '../version.js';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Public API
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate all AI agent configuration files for the project.
 */
export function generateAiConfig(config: NexusConfig): GeneratedFile[] {
  const files: GeneratedFile[] = [];

  // Core instruction file (the single source of truth)
  files.push(generateInstructions(config));

  // Tool-specific files at expected root paths â€” each embeds full instructions
  files.push(generateCursorRules(config));
  files.push(generateWindsurfRules(config));
  files.push(generateClineRules(config));
  files.push(generateAgentsMd(config));
  files.push(generateCopilotInstructions(config));

  return files;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Core instructions file (.nexus/ai/instructions.md)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateInstructions(config: NexusConfig): GeneratedFile {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';
  const backendDisplay =
    config.backendFramework === 'none'
      ? `${config.backendStrategy} (no framework)`
      : `${config.backendFramework} (${config.backendStrategy})`;

  const content = `# ${config.displayName} â€” AI Agent Instructions

> **This file is the single source of truth for all AI coding assistants.**
> It is auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.
> Root-level config files (.cursorrules, .windsurfrules, etc.) point here.

---

## âš ï¸ Before You Do Anything

**Read \`.nexus/docs/01_vision.md\` first** to understand what this project does.
Then read \`.nexus/docs/07_implementation.md\` for the build plan and file-by-file guide.

The full doc map is in \`.nexus/index.md\`.

---

## ðŸš¨ CRITICAL â€” Onboarding Protocol (Auto-Populate Docs)

Each NEXUS doc has YAML frontmatter with a \\\`status\\\` field:
- \\\`template\\\` â€” the doc is still in its default scaffolded state (has TODO placeholders)
- \\\`populated\\\` â€” the doc has been filled in by a human or AI agent

\\\`\\\`\\\`
STOP. If ANY .nexus/docs/ file has status: template â†’ you MUST populate it FIRST.
Do NOT skip this step. Do NOT jump straight to the user's request.
This is a hard requirement, not a suggestion.
\\\`\\\`\\\`

### Steps:

1. **Scan the codebase** â€” read \\\`package.json\\\`, \\\`tsconfig.json\\\`, source files in \\\`src/\\\`,
   route definitions, data models, and test files to understand the project.

2. **Auto-fill what you can infer** from the code:
   - \\\`02_architecture.md\\\` â€” tech stack, directory structure, data flow
   - \\\`03_data_contracts.md\\\` â€” schemas, types, validation from source code
   - \\\`04_api_contracts.md\\\` â€” routes, endpoints, request/response shapes
   - \\\`06_test_strategy.md\\\` â€” existing test setup, coverage, test patterns
   - \\\`07_implementation.md\\\` â€” current build state, what exists vs. what's planned
   - \\\`08_deployment.md\\\` â€” CI/CD config, environment variables, deploy targets

3. **Ask the user** for things you cannot infer from code:
   - \\\`01_vision.md\\\` â€” product vision, user personas, success metrics
   - \\\`05_business_logic.md\\\` â€” business rules, algorithms, decision logic
   - Any section where you have low confidence

4. **Update the frontmatter** of each doc you fill in:
   \\\`\\\`\\\`yaml
   status: populated
   confidence: high    # or medium/low
   last_updated: "YYYY-MM-DD"
   \\\`\\\`\\\`

5. **Then proceed** with whatever task the user originally requested.

This onboarding flow only applies when docs have \\\`status: template\\\`.
Once all docs are \\\`populated\\\`, skip this section and work normally.

---

## Project Identity

| Field | Value |
|-------|-------|
| **Name** | ${config.displayName} |
| **Type** | ${config.projectType} |
| **Framework** | ${frameworkDisplay} |
| **Data Strategy** | ${config.dataStrategy} |
| **Backend** | ${backendDisplay} |
| **Testing** | ${testDisplay} |
| **Package Manager** | ${config.packageManager} |
| **Generated With** | NEXUS CLI v${version} |

---

## Tech Stack

| Component | Technology |
|-----------|-----------|
| Frontend | ${frameworkDisplay} |
| Language | TypeScript (strict mode, ESM) |
| Data Strategy | ${config.dataStrategy} |
| Backend | ${backendDisplay} |
| Testing | ${testDisplay} |
| Package Manager | ${config.packageManager} |
| Patterns | ${patternsDisplay} |

---

## Code Rules

1. **TypeScript strict mode** â€” no \`any\`, no implicit returns, no unused variables
2. **ESM only** â€” use \`import\`/\`export\`, never \`require()\`
3. **File extensions in imports** â€” always use \`.js\` extension (e.g., \`import { foo } from './bar.js'\`)
4. **Conventional Commits** â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`, \`test:\`, \`refactor:\`
5. **Test everything** â€” every feature needs tests in \`tests/unit/\`
6. **Validate after changes** â€” run \`${getValidationCommand(config)}\`

---

## Architecture Rules

- Follow the patterns described in \`.nexus/docs/02_architecture.md\`
- Data models must match contracts in \`.nexus/docs/03_data_contracts.md\`
- API endpoints must match contracts in \`.nexus/docs/04_api_contracts.md\`
- Business logic rules are in \`.nexus/docs/05_business_logic.md\`
- Build order is defined in \`.nexus/docs/07_implementation.md\`

---

## Key Directories

| Directory | Purpose |
|-----------|---------|
| \`src/\` | Application source code |
| \`tests/\` | Unit, integration, and E2E tests |
| \`.nexus/docs/\` | NEXUS documentation system (8 files) |
| \`.nexus/\` | Project metadata, AI config, and manifest |
| \`public/\` | Static assets |
| \`.github/\` | CI/CD workflows, PR templates |

---

## NEXUS Documentation System

This project includes 8 structured documentation files designed for both humans and AI:

| # | File | Purpose |
|---|------|---------|
| 1 | \`.nexus/docs/01_vision.md\` | Product requirements, user stories, success metrics |
| 2 | \`.nexus/docs/02_architecture.md\` | System design, tech stack decisions, data flow |
| 3 | \`.nexus/docs/03_data_contracts.md\` | Database schemas, validation rules, relationships |
| 4 | \`.nexus/docs/04_api_contracts.md\` | Endpoints, request/response interfaces, status codes |
| 5 | \`.nexus/docs/05_business_logic.md\` | Rules, algorithms, state machines, decision flows |
| 6 | \`.nexus/docs/06_test_strategy.md\` | Coverage targets, test types, testing philosophy |
| 7 | \`.nexus/docs/07_implementation.md\` | Build order, file-by-file implementation plan |
| 8 | \`.nexus/docs/08_deployment.md\` | Infrastructure, CI/CD, environment configuration |

**Start with \`.nexus/docs/01_vision.md\`**, then follow the numbered order.

---

## Workflow

When implementing a feature:

1. **Read the relevant doc** â€” find the spec in \`.nexus/docs/\`
2. **Check the implementation plan** â€” \`.nexus/docs/07_implementation.md\`
3. **Write the code** following the architecture in \`.nexus/docs/02_architecture.md\`
4. **Write tests** â€” match the strategy in \`.nexus/docs/06_test_strategy.md\`
5. **Validate** â€” \`${getValidationCommand(config)}\`
6. **Commit** â€” use conventional commits (\`feat:\`, \`fix:\`, etc.)

---

*Generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version} â€” AI-native project scaffolding by [GDA Africa](https://github.com/GDA-Africa)*
`;

  return { path: '.nexus/ai/instructions.md', content };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Tool-specific instruction files
 *
 * Every AI tool gets the FULL project-aware instructions embedded
 * directly in its config file. We do NOT rely on "go read another
 * file" directives â€” AI tools ignore them too often.
 *
 * A shared helper generates the content; each tool function just
 * sets the correct output path and tool-specific header.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate full project-aware instruction content for any AI tool.
 * This is embedded directly in each tool's config file so the AI
 * never has to follow a cross-file pointer.
 */
function toolInstructionContent(config: NexusConfig, toolName: string): string {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';

  return `# ${config.displayName} â€” ${toolName} Instructions

> Auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.
> Full instructions also at \`.nexus/ai/instructions.md\`.

---

## ðŸš¨ CRITICAL â€” Read This First (Onboarding Protocol)

This project uses the **NEXUS Documentation System** â€” 8 structured markdown files
in \`.nexus/docs/\` that describe every aspect of the project.

Each doc has YAML frontmatter with a \`status\` field:
- \`template\` â€” still has TODO placeholders, needs to be filled in
- \`populated\` â€” already filled in by a human or AI

### STOP. Before doing ANYTHING the user asks, check the docs:

\`\`\`
If ANY .nexus/docs/ file has status: template â†’ you MUST populate it FIRST.
Do NOT skip this. Do NOT go straight to the user's request.
This is a HARD REQUIREMENT, not a suggestion.
\`\`\`

**Step 1 â€” Scan the codebase:** Read \`package.json\`, \`tsconfig.json\`, source files,
routes, data models, and tests to understand the project.

**Step 2 â€” Auto-fill what you can infer** from the code:
- \`02_architecture.md\` â€” tech stack, directory structure, data flow
- \`03_data_contracts.md\` â€” schemas, types, validation from source code
- \`04_api_contracts.md\` â€” routes, endpoints, request/response shapes
- \`06_test_strategy.md\` â€” existing test setup, coverage, patterns
- \`07_implementation.md\` â€” current build state, what exists vs. planned
- \`08_deployment.md\` â€” CI/CD config, environment variables

**Step 3 â€” Ask the user** for things you cannot infer:
- \`01_vision.md\` â€” product vision, user personas, success metrics
- \`05_business_logic.md\` â€” business rules, algorithms, decision logic

**Step 4 â€” Update frontmatter** of each doc you fill in:
\`\`\`yaml
status: populated
confidence: high    # or medium/low
last_updated: "YYYY-MM-DD"
\`\`\`

**Step 5 â€” THEN** proceed with whatever the user originally asked.

This only applies when docs have \`status: template\`. Once populated, work normally.

---

## Project: ${config.displayName}

- **Type:** ${config.projectType}
- **Framework:** ${frameworkDisplay}
- **Data Strategy:** ${config.dataStrategy}
- **Testing:** ${testDisplay}
- **Package Manager:** ${config.packageManager}
- **Patterns:** ${patternsDisplay}

## Documentation Map

| # | File | Purpose |
|---|------|---------|
| 1 | \`.nexus/docs/01_vision.md\` | Product requirements, user stories |
| 2 | \`.nexus/docs/02_architecture.md\` | System design, tech stack |
| 3 | \`.nexus/docs/03_data_contracts.md\` | Database schemas, validation |
| 4 | \`.nexus/docs/04_api_contracts.md\` | Endpoints, interfaces |
| 5 | \`.nexus/docs/05_business_logic.md\` | Rules, algorithms, flows |
| 6 | \`.nexus/docs/06_test_strategy.md\` | Coverage targets, test types |
| 7 | \`.nexus/docs/07_implementation.md\` | Build order, file plan |
| 8 | \`.nexus/docs/08_deployment.md\` | Infrastructure, CI/CD |

## Code Rules

- TypeScript strict mode â€” no \`any\`, no implicit returns
- ESM only â€” \`import\`/\`export\`, never \`require()\`
- File extensions in imports â€” always \`.js\`
- Conventional Commits â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`
- Test everything â€” \`tests/unit/\`
- Validate: \`${getValidationCommand(config)}\`

## Full Instructions

For the complete rule set (architecture rules, key directories, workflow),
read \`.nexus/ai/instructions.md\`.
`;
}

function generateCursorRules(config: NexusConfig): GeneratedFile {
  return { path: '.cursorrules', content: toolInstructionContent(config, 'Cursor') };
}

function generateWindsurfRules(config: NexusConfig): GeneratedFile {
  return { path: '.windsurfrules', content: toolInstructionContent(config, 'Windsurf') };
}

function generateClineRules(config: NexusConfig): GeneratedFile {
  return { path: '.clinerules', content: toolInstructionContent(config, 'Cline') };
}

function generateAgentsMd(config: NexusConfig): GeneratedFile {
  return { path: 'AGENTS.md', content: toolInstructionContent(config, 'Claude Code / OpenAI Codex') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * GitHub Copilot â€” requires .github/copilot-instructions.md
 *
 * Uses the same shared content as all other tools.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateCopilotInstructions(config: NexusConfig): GeneratedFile {
  return { path: '.github/copilot-instructions.md', content: toolInstructionContent(config, 'GitHub Copilot') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Helpers
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function getFrameworkDisplay(framework: string): string {
  const map: Record<string, string> = {
    nextjs: 'Next.js 15 (App Router)',
    'react-vite': 'React + Vite',
    sveltekit: 'SvelteKit',
    nuxt: 'Nuxt 3',
    astro: 'Astro',
    remix: 'Remix',
  };
  return map[framework] ?? framework;
}

function getValidationCommand(config: NexusConfig): string {
  const pm = config.packageManager;
  const runPrefix = pm === 'npm' ? 'npm run' : pm;
  const testCmd = config.testFramework !== 'none' ? ` && ${runPrefix} test` : '';
  return `npx tsc --noEmit${testCmd} && ${runPrefix} lint`;
}
