/**
 * NEXUS CLI - AI Config Generator
 *
 * Generates AI agent instruction files for every major coding assistant.
 *
 * Strategy:
 *   The master file lives in `.nexus/ai/instructions.md` â€” a single folder
 *   that beginners can understand ("this is for AI tools").
 *
 *   EVERY tool-specific config file gets the FULL project-aware instructions
 *   embedded directly. We do NOT rely on "go read another file" directives
 *   because AI tools ignore cross-file pointers too often.
 *
 *   Files generated:
 *     .nexus/ai/instructions.md       â€” master file (full content)
 *     .cursorrules                     â€” Cursor (full content)
 *     .windsurfrules                   â€” Windsurf (full content)
 *     .clinerules                      â€” Cline (full content)
 *     AGENTS.md                        â€” Claude Code / OpenAI Codex (full content)
 *     .github/copilot-instructions.md  â€” GitHub Copilot (full content)
 *
 *   Every file is project-aware â€” it references the actual framework, data
 *   strategy, test framework, and patterns chosen during `nexus init`.
 *   Every file includes the onboarding protocol that tells the AI to
 *   populate template docs BEFORE doing anything the user asks.
 */

import type { NexusConfig } from '../types/config.js';
import type { GeneratedFile } from '../types/templates.js';
import { version } from '../version.js';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Public API
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate all AI agent configuration files for the project.
 */
export function generateAiConfig(config: NexusConfig): GeneratedFile[] {
  const files: GeneratedFile[] = [];

  // Core instruction file (the single source of truth)
  files.push(generateInstructions(config));

  // Tool-specific files at expected root paths â€” each embeds full instructions
  files.push(generateCursorRules(config));
  files.push(generateWindsurfRules(config));
  files.push(generateClineRules(config));
  files.push(generateAgentsMd(config));
  files.push(generateCopilotInstructions(config));

  return files;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Core instructions file (.nexus/ai/instructions.md)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateInstructions(config: NexusConfig): GeneratedFile {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';
  const backendDisplay =
    config.backendFramework === 'none'
      ? `${config.backendStrategy} (no framework)`
      : `${config.backendFramework} (${config.backendStrategy})`;

  const content = `# ${config.displayName} â€” AI Agent Instructions

> **This file is the single source of truth for all AI coding assistants.**
> It is auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.
> Root-level config files (.cursorrules, .windsurfrules, etc.) embed these same rules.

---

## ðŸ§  YOUR BRAIN: \`.nexus/docs/index.md\`

**READ \`.nexus/docs/index.md\` FIRST. EVERY TIME. NO EXCEPTIONS.**

That file is your project brain. It contains:
- **Current Objective** â€” what you should be working on right now
- **Status Matrix** â€” what's done, what's in progress, what's blocked
- **Feature Backlog** â€” the prioritized roadmap of what to build
- **What Has Been Built** â€” every module, file, and test that exists
- **Progress Log** â€” session-by-session changelog (your memory)
- **What's Next** â€” your prioritized TODO list
- **Operating Rules** â€” the rules you MUST follow

\`\`\`
RULE: Before EVERY task, read .nexus/docs/index.md
RULE: After EVERY task, update .nexus/docs/index.md
RULE: When the user asks "what should we work on?" â†’ check the index
RULE: When you finish a feature â†’ update the index, then suggest the next item
RULE: NEVER ask "what enhancements would you like?" â€” the index has the answer
\`\`\`

---

## ðŸš¨ CRITICAL â€” Onboarding Protocol (First-Time Setup)

Each NEXUS doc has YAML frontmatter with a \\\`status\\\` field:
- \\\`template\\\` â€” the doc is still in its default scaffolded state (has TODO placeholders)
- \\\`populated\\\` â€” the doc has been filled in by a human or AI agent

\\\`\\\`\\\`
STOP. If ANY .nexus/docs/ file has status: template â†’ you MUST populate it FIRST.
Do NOT skip this step. Do NOT jump straight to the user's request.
This is a hard requirement, not a suggestion.
\\\`\\\`\\\`
\\\`\\\`\\\`

### Steps:

1. **Scan the codebase** â€” read \\\`package.json\\\`, \\\`tsconfig.json\\\`, source files in \\\`src/\\\`,
   route definitions, data models, and test files to understand the project.

2. **Ask the user about their vision** â€” what are they building? Who are the users?
   What features do they need? Fill in \\\`01_vision.md\\\` and \\\`05_business_logic.md\\\`.

3. **Auto-fill what you can infer** from the code:
   - \\\`02_architecture.md\\\` â€” tech stack, directory structure, data flow
   - \\\`03_data_contracts.md\\\` â€” schemas, types, validation from source code
   - \\\`04_api_contracts.md\\\` â€” routes, endpoints, request/response shapes
   - \\\`06_test_strategy.md\\\` â€” existing test setup, coverage, test patterns
   - \\\`08_deployment.md\\\` â€” CI/CD config, environment variables, deploy targets

4. **Build the implementation plan** (\\\`07_implementation.md\\\`):
   - Turn features from \\\`01_vision.md\\\` into concrete build phases
   - Create a file-by-file plan with every file that needs to be created
   - Set the current phase based on what already exists
   - This is HOW you know what code to write

5. **Update the frontmatter** of each doc you fill in:
   \\\`\\\`\\\`yaml
   status: populated
   confidence: high    # or medium/low
   last_updated: "YYYY-MM-DD"
   \\\`\\\`\\\`

6. **Build the project brain** (\\\`.nexus/docs/index.md\\\`):
   - Fill in the feature backlog from \\\`01_vision.md\\\` features
   - Update the status matrix to reflect what's populated
   - Update "What Has Been Built" to reflect current state
   - Set "What's Next" to the first real feature from the backlog
   - **This step is CRITICAL â€” this file drives all future work**

7. **THEN proceed** with the user's original request â€” or suggest
   the first item from "What's Next" in the index.

This onboarding flow only applies when docs have \\\`status: template\\\`.
Once all docs are \\\`populated\\\`, skip this section and work normally â€”
but ALWAYS read \\\`.nexus/docs/index.md\\\` before every task.

---

## Project Identity

| Field | Value |
|-------|-------|
| **Name** | ${config.displayName} |
| **Type** | ${config.projectType} |
| **Framework** | ${frameworkDisplay} |
| **Data Strategy** | ${config.dataStrategy} |
| **Backend** | ${backendDisplay} |
| **Testing** | ${testDisplay} |
| **Package Manager** | ${config.packageManager} |
| **Generated With** | NEXUS CLI v${version} |

---

## Tech Stack

| Component | Technology |
|-----------|-----------|
| Frontend | ${frameworkDisplay} |
| Language | TypeScript (strict mode, ESM) |
| Data Strategy | ${config.dataStrategy} |
| Backend | ${backendDisplay} |
| Testing | ${testDisplay} |
| Package Manager | ${config.packageManager} |
| Patterns | ${patternsDisplay} |

---

## Code Rules

1. **TypeScript strict mode** â€” no \`any\`, no implicit returns, no unused variables
2. **ESM only** â€” use \`import\`/\`export\`, never \`require()\`
3. **File extensions in imports** â€” always use \`.js\` extension (e.g., \`import { foo } from './bar.js'\`)
4. **Conventional Commits** â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`, \`test:\`, \`refactor:\`
5. **Test everything** â€” every feature needs tests in \`tests/unit/\`
6. **Validate after changes** â€” run \`${getValidationCommand(config)}\`

---

## Architecture Rules

- Follow the patterns described in \`.nexus/docs/02_architecture.md\`
- Data models must match contracts in \`.nexus/docs/03_data_contracts.md\`
- API endpoints must match contracts in \`.nexus/docs/04_api_contracts.md\`
- Business logic rules are in \`.nexus/docs/05_business_logic.md\`
- Build order is defined in \`.nexus/docs/07_implementation.md\`

---

## Key Directories

| Directory | Purpose |
|-----------|---------|
| \`src/\` | Application source code |
| \`tests/\` | Unit, integration, and E2E tests |
| \`.nexus/docs/\` | NEXUS documentation system (8 files) |
| \`.nexus/\` | Project metadata, AI config, and manifest |
| \`public/\` | Static assets |
| \`.github/\` | CI/CD workflows, PR templates |

---

## NEXUS Documentation System

This project includes 8 structured documentation files designed for both humans and AI:

| # | File | Purpose |
|---|------|---------|
| 1 | \`.nexus/docs/01_vision.md\` | Product requirements, user stories, success metrics |
| 2 | \`.nexus/docs/02_architecture.md\` | System design, tech stack decisions, data flow |
| 3 | \`.nexus/docs/03_data_contracts.md\` | Database schemas, validation rules, relationships |
| 4 | \`.nexus/docs/04_api_contracts.md\` | Endpoints, request/response interfaces, status codes |
| 5 | \`.nexus/docs/05_business_logic.md\` | Rules, algorithms, state machines, decision flows |
| 6 | \`.nexus/docs/06_test_strategy.md\` | Coverage targets, test types, testing philosophy |
| 7 | \`.nexus/docs/07_implementation.md\` | Build order, file-by-file implementation plan |
| 8 | \`.nexus/docs/08_deployment.md\` | Infrastructure, CI/CD, environment configuration |
| ðŸ§  | \`.nexus/docs/index.md\` | **PROJECT BRAIN** â€” status, backlog, progress, what's next |
| ðŸ“š | \`.nexus/docs/knowledge.md\` | **KNOWLEDGE BASE** â€” learned insights, patterns, gotchas |

**Start with \`.nexus/docs/index.md\`** (your brain), then \`.nexus/docs/01_vision.md\`.

---

## Workflow â€” How To Work On This Project

### Before EVERY task:
1. **Read \`.nexus/docs/index.md\`** â€” check "Current Objective" and "What's Next"
2. **Read the relevant spec doc** â€” find details in the numbered \`.nexus/docs/\` files
3. **Scan \`.nexus/docs/knowledge.md\`** â€” check for relevant past learnings before making decisions
4. **Check \`.nexus/docs/07_implementation.md\`** â€” find the file-by-file plan

### During the task:
4. **Write the code** following the architecture in \`.nexus/docs/02_architecture.md\`
5. **Write tests** â€” match the strategy in \`.nexus/docs/06_test_strategy.md\`
6. **Validate** â€” \`${getValidationCommand(config)}\`

### After EVERY task:
7. **Update \`.nexus/docs/index.md\`**:
   - Move completed items from "What's Next" to "Progress Log"
   - Update the "Status Matrix" and "What Has Been Built"
   - Set the "Current Objective" to the next priority item
8. **Update \`.nexus/docs/07_implementation.md\`** â€” mark completed files/tasks
9. **Learn** â€” if you discovered something non-obvious (bug pattern, architecture insight, package quirk, performance fix), append an entry to \`.nexus/docs/knowledge.md\`
10. **Commit** â€” use conventional commits (\`feat:\`, \`fix:\`, etc.)
11. **Suggest the next task** from \`.nexus/docs/index.md\` "What's Next"

### NEVER do this:
- âŒ Ask "what enhancements would you like?" when the backlog has items
- âŒ Invent random features not in the backlog
- âŒ Skip updating the index after completing work
- âŒ Treat docs as static â€” they evolve with the project

---

*Generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version} â€” AI-native project scaffolding by [GDA Africa](https://github.com/GDA-Africa)*
`;

  return { path: '.nexus/ai/instructions.md', content };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Tool-specific instruction files
 *
 * Every AI tool gets the FULL project-aware instructions embedded
 * directly in its config file. We do NOT rely on "go read another
 * file" directives â€” AI tools ignore them too often.
 *
 * A shared helper generates the content; each tool function just
 * sets the correct output path and tool-specific header.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate full project-aware instruction content for any AI tool.
 * This is embedded directly in each tool's config file so the AI
 * never has to follow a cross-file pointer.
 */
function toolInstructionContent(config: NexusConfig, toolName: string): string {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';

  return `# ${config.displayName} â€” ${toolName} Instructions

> Auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.

## ðŸ§  YOUR BRAIN: \`.nexus/docs/index.md\`

**Read it FIRST. Every time. No exceptions.**

It contains: current objective, feature backlog, progress log, what's next.

\`\`\`
RULE: Before EVERY task â†’ read .nexus/docs/index.md
RULE: After EVERY task â†’ update .nexus/docs/index.md
RULE: NEVER ask "what enhancements would you like?" â†’ the index has the answer
RULE: NEVER invent features â†’ work from the feature backlog
\`\`\`

## ðŸš¨ First-Time Onboarding

If ANY \`.nexus/docs/\` file has \`status: template\` in its YAML frontmatter:

**STOP. Populate the docs BEFORE doing anything else.**
Read \`.nexus/ai/instructions.md\` for the full onboarding steps.

## Project

| Field | Value |
|-------|-------|
| Name | ${config.displayName} |
| Type | ${config.projectType} |
| Framework | ${frameworkDisplay} |
| Data | ${config.dataStrategy} |
| Testing | ${testDisplay} |
| Package Manager | ${config.packageManager} |
| Patterns | ${patternsDisplay} |

## Workflow

1. **Before:** Read \`.nexus/docs/index.md\` â†’ check "What's Next". Scan \`.nexus/docs/knowledge.md\` for relevant past learnings
2. **During:** Write code + tests, validate with \`${getValidationCommand(config)}\`
3. **After:** Update \`.nexus/docs/index.md\` â†’ move item to Progress Log. If you learned something non-obvious, append to \`.nexus/docs/knowledge.md\`
4. **Suggest:** The next item from the backlog

## Code Rules

- TypeScript strict mode â€” no \`any\`, no implicit returns
- ESM only â€” \`import\`/\`export\`, never \`require()\`
- Conventional Commits â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`
- Test everything â€” validate: \`${getValidationCommand(config)}\`

## Docs

| File | Purpose |
|------|---------|
| \`.nexus/docs/index.md\` | **ðŸ§  Project brain** â€” status, backlog, what's next |
| \`.nexus/ai/instructions.md\` | Full AI rules, onboarding protocol, architecture |
| \`.nexus/docs/knowledge.md\` | **ðŸ“š Knowledge base** â€” learned insights, patterns, gotchas |
| \`.nexus/docs/01_vision.md\` | Vision, features, personas |
| \`.nexus/docs/07_implementation.md\` | Build order, file-by-file plan |
`;
}

function generateCursorRules(config: NexusConfig): GeneratedFile {
  return { path: '.cursorrules', content: toolInstructionContent(config, 'Cursor') };
}

function generateWindsurfRules(config: NexusConfig): GeneratedFile {
  return { path: '.windsurfrules', content: toolInstructionContent(config, 'Windsurf') };
}

function generateClineRules(config: NexusConfig): GeneratedFile {
  return { path: '.clinerules', content: toolInstructionContent(config, 'Cline') };
}

function generateAgentsMd(config: NexusConfig): GeneratedFile {
  return { path: 'AGENTS.md', content: toolInstructionContent(config, 'Claude Code / OpenAI Codex') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * GitHub Copilot â€” requires .github/copilot-instructions.md
 *
 * Uses the same shared content as all other tools.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateCopilotInstructions(config: NexusConfig): GeneratedFile {
  return { path: '.github/copilot-instructions.md', content: toolInstructionContent(config, 'GitHub Copilot') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Helpers
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function getFrameworkDisplay(framework: string): string {
  const map: Record<string, string> = {
    nextjs: 'Next.js 15 (App Router)',
    'react-vite': 'React + Vite',
    sveltekit: 'SvelteKit',
    nuxt: 'Nuxt 3',
    astro: 'Astro',
    remix: 'Remix',
  };
  return map[framework] ?? framework;
}

function getValidationCommand(config: NexusConfig): string {
  const pm = config.packageManager;
  const runPrefix = pm === 'npm' ? 'npm run' : pm;
  const testCmd = config.testFramework !== 'none' ? ` && ${runPrefix} test` : '';
  return `npx tsc --noEmit${testCmd} && ${runPrefix} lint`;
}
