/**
 * NEXUS CLI - AI Config Generator
 *
 * Generates AI agent instruction files for every major coding assistant.
 *
 * Strategy:
 *   The master file lives in `.nexus/ai/instructions.md` â€” a single folder
 *   that beginners can understand ("this is for AI tools").
 *
 *   EVERY tool-specific config file gets the FULL project-aware instructions
 *   embedded directly. We do NOT rely on "go read another file" directives
 *   because AI tools ignore cross-file pointers too often.
 *
 *   Files generated:
 *     .nexus/ai/instructions.md       â€” master file (full content)
 *     .cursorrules                     â€” Cursor (full content)
 *     .windsurfrules                   â€” Windsurf (full content)
 *     .clinerules                      â€” Cline (full content)
 *     AGENTS.md                        â€” Claude Code / OpenAI Codex (full content)
 *     .github/copilot-instructions.md  â€” GitHub Copilot (full content)
 *
 *   Every file is project-aware â€” it references the actual framework, data
 *   strategy, test framework, and patterns chosen during `nexus init`.
 *   Every file includes the onboarding protocol that tells the AI to
 *   populate template docs BEFORE doing anything the user asks.
 */

import type { NexusConfig, NexusPersona } from '../types/config.js';
import type { GeneratedFile } from '../types/templates.js';
import { version } from '../version.js';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Public API
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate all AI agent configuration files for the project.
 */
export function generateAiConfig(config: NexusConfig): GeneratedFile[] {
  const files: GeneratedFile[] = [];

  // Core instruction file (the single source of truth)
  files.push(generateInstructions(config));

  // Tool-specific files at expected root paths â€” each embeds full instructions
  files.push(generateCursorRules(config));
  files.push(generateWindsurfRules(config));
  files.push(generateClineRules(config));
  files.push(generateAgentsMd(config));
  files.push(generateCopilotInstructions(config));

  return files;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Core instructions file (.nexus/ai/instructions.md)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateInstructions(config: NexusConfig): GeneratedFile {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';
  const backendDisplay =
    config.backendFramework === 'none'
      ? `${config.backendStrategy} (no framework)`
      : `${config.backendFramework} (${config.backendStrategy})`;

  const content = `# ${config.displayName} â€” AI Agent Instructions

> **This file is the single source of truth for all AI coding assistants.**
> It is auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.
> Root-level config files (.cursorrules, .windsurfrules, etc.) embed these same rules.

---

## âš ï¸ Before You Do Anything â€” 3 Mandatory Steps

You MUST complete these 3 steps before doing ANY work. This is not optional.

**Step 1. Read your brain â€” \`.nexus/docs/index.md\`**

This file is your project brain. It tells you:
- What has been built (do not recreate it)
- What to work on next (the "What's Next" section)
- The current objective and status of every component

**Step 2. Scan the knowledge base â€” \`.nexus/docs/knowledge.md\`**

This file is the project's long-term memory. It contains past decisions, bug fixes,
architecture insights, and gotchas discovered during development. Read the headings
to find entries relevant to your current task. This prevents you from repeating
mistakes or contradicting past decisions.

**Step 3. Read the relevant spec doc** from \`.nexus/docs/\` (01 through 08).

\`\`\`
RULE: Before EVERY task â†’ read .nexus/docs/index.md (your brain)
RULE: Before EVERY task â†’ scan .nexus/docs/knowledge.md (your memory)
RULE: After EVERY task â†’ update .nexus/docs/index.md
RULE: After EVERY task â†’ append to .nexus/docs/knowledge.md if you learned something
RULE: NEVER ask "what should we work on?" â†’ the index tells you
RULE: NEVER invent features â†’ work from the feature backlog in the index
\`\`\`

---

## ğŸš¨ CRITICAL â€” Onboarding Protocol (First-Time Setup)

Each NEXUS doc has YAML frontmatter with a \\\`status\\\` field:
- \\\`template\\\` â€” the doc is still in its default scaffolded state (has TODO placeholders)
- \\\`populated\\\` â€” the doc has been filled in by a human or AI agent

\\\`\\\`\\\`
STOP. If ANY .nexus/docs/ file has status: template â†’ you MUST populate it FIRST.
Do NOT skip this step. Do NOT jump straight to the user's request.
This is a hard requirement, not a suggestion.
\\\`\\\`\\\`

### Steps:

1. **Scan the codebase** â€” read \\\`package.json\\\`, \\\`tsconfig.json\\\`, source files in \\\`src/\\\`,
   route definitions, data models, and test files to understand the project.

2. **Ask the user about their vision** â€” what are they building? Who are the users?
   What features do they need? Fill in \\\`01_vision.md\\\` and \\\`05_business_logic.md\\\`.

3. **Auto-fill what you can infer** from the code:
   - \\\`02_architecture.md\\\` â€” tech stack, directory structure, data flow
   - \\\`03_data_contracts.md\\\` â€” schemas, types, validation from source code
   - \\\`04_api_contracts.md\\\` â€” routes, endpoints, request/response shapes
   - \\\`06_test_strategy.md\\\` â€” existing test setup, coverage, test patterns
   - \\\`08_deployment.md\\\` â€” CI/CD config, environment variables, deploy targets

4. **Build the implementation plan** (\\\`07_implementation.md\\\`):
   - Turn features from \\\`01_vision.md\\\` into concrete build phases
   - Create a file-by-file plan with every file that needs to be created
   - Set the current phase based on what already exists
   - This is HOW you know what code to write

5. **Update the frontmatter** of each doc you fill in:
   \\\`\\\`\\\`yaml
   status: populated
   confidence: high    # or medium/low
   last_updated: "YYYY-MM-DD"
   \\\`\\\`\\\`

6. **Build the project brain** (\\\`.nexus/docs/index.md\\\`):
   - Fill in the feature backlog from \\\`01_vision.md\\\` features
   - Update the status matrix to reflect what's populated
   - Update "What Has Been Built" to reflect current state
   - Set "What's Next" to the first real feature from the backlog
   - **This step is CRITICAL â€” this file drives all future work**

7. **THEN proceed** with the user's original request â€” or suggest
   the first item from "What's Next" in the index.

This onboarding flow only applies when docs have \\\`status: template\\\`.
Once all docs are \\\`populated\\\`, skip this section and work normally â€”
but ALWAYS read \\\`.nexus/docs/index.md\\\` before every task.

---

## Project Identity

| Field | Value |
|-------|-------|
| **Name** | ${config.displayName} |
| **Type** | ${config.projectType} |
| **Framework** | ${frameworkDisplay} |
| **Data Strategy** | ${config.dataStrategy} |
| **Backend** | ${backendDisplay} |
| **Testing** | ${testDisplay} |
| **Package Manager** | ${config.packageManager} |
| **Generated With** | NEXUS CLI v${version} |

---

## Tech Stack

| Component | Technology |
|-----------|-----------|
| Frontend | ${frameworkDisplay} |
| Language | TypeScript (strict mode, ESM) |
| Data Strategy | ${config.dataStrategy} |
| Backend | ${backendDisplay} |
| Testing | ${testDisplay} |
| Package Manager | ${config.packageManager} |
| Patterns | ${patternsDisplay} |

---

## Code Rules

1. **TypeScript strict mode** â€” no \`any\`, no implicit returns, no unused variables
2. **ESM only** â€” use \`import\`/\`export\`, never \`require()\`
3. **File extensions in imports** â€” always use \`.js\` extension (e.g., \`import { foo } from './bar.js'\`)
4. **Conventional Commits** â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`, \`test:\`, \`refactor:\`
5. **Test everything** â€” every feature needs tests in \`tests/unit/\`
6. **Validate after changes** â€” run \`${getValidationCommand(config)}\`

---

## Architecture Rules

- Follow the patterns described in \`.nexus/docs/02_architecture.md\`
- Data models must match contracts in \`.nexus/docs/03_data_contracts.md\`
- API endpoints must match contracts in \`.nexus/docs/04_api_contracts.md\`
- Business logic rules are in \`.nexus/docs/05_business_logic.md\`
- Build order is defined in \`.nexus/docs/07_implementation.md\`

---

## Key Directories

| Directory | Purpose |
|-----------|---------|
| \`src/\` | Application source code |
| \`tests/\` | Unit, integration, and E2E tests |
| \`.nexus/docs/\` | NEXUS documentation system (8 files + brain + knowledge) |
| \`.nexus/\` | Project metadata, AI config, and manifest |
| \`public/\` | Static assets |
| \`.github/\` | CI/CD workflows, PR templates |

---

## NEXUS Documentation System

This project includes structured documentation files designed for both humans and AI:

| # | File | Purpose |
|---|------|---------|
| ğŸ§  | \`.nexus/docs/index.md\` | **PROJECT BRAIN** â€” status, backlog, progress, what's next |
| ğŸ“š | \`.nexus/docs/knowledge.md\` | **KNOWLEDGE BASE** â€” learned insights, patterns, gotchas |
| 1 | \`.nexus/docs/01_vision.md\` | Product requirements, user stories, success metrics |
| 2 | \`.nexus/docs/02_architecture.md\` | System design, tech stack decisions, data flow |
| 3 | \`.nexus/docs/03_data_contracts.md\` | Database schemas, validation rules, relationships |
| 4 | \`.nexus/docs/04_api_contracts.md\` | Endpoints, request/response interfaces, status codes |
| 5 | \`.nexus/docs/05_business_logic.md\` | Rules, algorithms, state machines, decision flows |
| 6 | \`.nexus/docs/06_test_strategy.md\` | Coverage targets, test types, testing philosophy |
| 7 | \`.nexus/docs/07_implementation.md\` | Build order, file-by-file implementation plan |
| 8 | \`.nexus/docs/08_deployment.md\` | Infrastructure, CI/CD, environment configuration |

**Start with \`.nexus/docs/index.md\`** (your brain), then \`.nexus/docs/01_vision.md\`.

---

## ğŸ“š Knowledge Base Protocol

The knowledge base (\`.nexus/docs/knowledge.md\`) is the project's long-term memory.
It is **append-only** â€” entries are never deleted, only added.

### When to READ it:
- **Before every task** â€” scan the headings for entries relevant to your work
- **Before architectural decisions** â€” check for past decisions and their rationale
- **Before debugging** â€” check for known gotchas and recurring bug patterns
- **Before choosing packages or patterns** â€” check for past evaluations

### When to WRITE to it:
- **After discovering something non-obvious** â€” a bug root cause, an architecture insight, a package quirk
- **After making a decision that future agents should know about**
- **NOT for routine task completion** â€” that goes in \`index.md\` Progress Log

### Entry format:
\`\`\`
## [YYYY-MM-DD] category â€” title
Description of the discovery. One to three sentences max.
\`\`\`

### Categories:
| Tag | Use When |
|-----|----------|
| \`architecture\` | Design decisions, structural choices, why X over Y |
| \`bug-fix\` | Recurring bugs, root causes, things to watch for |
| \`pattern\` | Code patterns that work well (or don't) in this project |
| \`package\` | Package quirks, version issues, config gotchas |
| \`performance\` | Bottlenecks found, optimizations applied |
| \`convention\` | Team/project conventions established during development |
| \`gotcha\` | Non-obvious traps, edge cases, things that wasted time |

### Rules:
- **NEVER delete entries** â€” the knowledge base is append-only
- **Keep entries short** â€” 1-3 sentences, not essays
- **Use the format above** â€” so future agents can scan headings quickly

---

## Workflow â€” How To Work On This Project

### Before EVERY task:
1. **Read \`.nexus/docs/index.md\`** â€” check "Current Objective" and "What's Next"
2. **Scan \`.nexus/docs/knowledge.md\`** â€” check for relevant past learnings before making decisions
3. **Read the relevant spec doc** â€” find details in the numbered \`.nexus/docs/\` files
4. **Check \`.nexus/docs/07_implementation.md\`** â€” find the file-by-file plan

### During the task:
5. **Write the code** following the architecture in \`.nexus/docs/02_architecture.md\`
6. **Write tests** â€” match the strategy in \`.nexus/docs/06_test_strategy.md\`
7. **Validate** â€” \`${getValidationCommand(config)}\`

### After EVERY task:
8. **Update \`.nexus/docs/index.md\`**:
   - Move completed items from "What's Next" to "Progress Log"
   - Update the "Status Matrix" and "What Has Been Built"
   - Set the "Current Objective" to the next priority item
9. **Update \`.nexus/docs/07_implementation.md\`** â€” mark completed files/tasks
10. **Learn** â€” if you discovered something non-obvious (bug pattern, architecture insight, package quirk, performance fix), append an entry to \`.nexus/docs/knowledge.md\`
11. **Commit** â€” use conventional commits (\`feat:\`, \`fix:\`, etc.)
12. **Suggest the next task** from \`.nexus/docs/index.md\` "What's Next"

### NEVER do this:
- âŒ Ask "what enhancements would you like?" when the backlog has items
- âŒ Invent random features not in the backlog
- âŒ Skip updating the index after completing work
- âŒ Treat docs as static â€” they evolve with the project
- âŒ Ignore \`.nexus/docs/knowledge.md\` â€” it prevents repeating mistakes
- âŒ Delete entries from \`.nexus/docs/knowledge.md\` â€” it is append-only
${getPersonaSection(config.persona)}
*Generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version} â€” AI-native project scaffolding by [GDA Africa](https://github.com/GDA-Africa)*
`;

  return { path: '.nexus/ai/instructions.md', content };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Tool-specific instruction files
 *
 * Every AI tool gets the FULL project-aware instructions embedded
 * directly in its config file. We do NOT rely on "go read another
 * file" directives â€” AI tools ignore them too often.
 *
 * A shared helper generates the content; each tool function just
 * sets the correct output path and tool-specific header.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * Generate full project-aware instruction content for any AI tool.
 * This is embedded directly in each tool's config file so the AI
 * never has to follow a cross-file pointer.
 */
function toolInstructionContent(config: NexusConfig, toolName: string): string {
  const frameworkDisplay = getFrameworkDisplay(config.frontendFramework);
  const testDisplay = config.testFramework === 'none' ? 'None configured' : config.testFramework;
  const patternsDisplay =
    config.appPatterns.length > 0 ? config.appPatterns.join(', ') : 'None selected';
  const backendDisplay =
    config.backendFramework === 'none'
      ? `${config.backendStrategy} (no framework)`
      : `${config.backendFramework} (${config.backendStrategy})`;

  return `# ${config.displayName} â€” ${toolName} Instructions

> Auto-generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}.
> This file contains the FULL project-aware instructions â€” do NOT skip any section.
> The master copy lives at \`.nexus/ai/instructions.md\`.

---

## âš ï¸ Before You Do Anything â€” 3 Mandatory Steps

You MUST complete these 3 steps before doing ANY work. This is not optional.

**Step 1. Read your brain â€” \`.nexus/docs/index.md\`**

READ \`.nexus/docs/index.md\` FIRST. EVERY TIME. NO EXCEPTIONS.

This file is your project brain. It tells you:
- What has been built (do not recreate it)
- What to work on next (the "What's Next" section)
- The current objective and status of every component
- The feature backlog â€” your prioritized roadmap
- The progress log â€” your session-by-session memory

**Step 2. Scan the knowledge base â€” \`.nexus/docs/knowledge.md\`**

This file is the project's long-term memory. It contains past decisions, bug fixes,
architecture insights, and gotchas discovered during development. Read the headings
to find entries relevant to your current task. This prevents you from repeating
mistakes or contradicting past decisions.

**Step 3. Read the relevant spec doc** from \`.nexus/docs/\` (01 through 08).

\`\`\`
RULE: Before EVERY task â†’ read .nexus/docs/index.md (your brain)
RULE: Before EVERY task â†’ scan .nexus/docs/knowledge.md (your memory)
RULE: After EVERY task â†’ update .nexus/docs/index.md
RULE: After EVERY task â†’ append to .nexus/docs/knowledge.md if you learned something
RULE: NEVER ask "what enhancements would you like?" â†’ the index has the answer
RULE: NEVER invent features â†’ work from the feature backlog in the index
\`\`\`

---

## ğŸš¨ CRITICAL â€” Onboarding Protocol (First-Time Setup)

Each NEXUS doc has YAML frontmatter with a \\\`status\\\` field:
- \\\`template\\\` â€” the doc is still in its default scaffolded state
- \\\`populated\\\` â€” the doc has been filled in by a human or AI agent

\\\`\\\`\\\`
STOP. If ANY .nexus/docs/ file has status: template â†’ you MUST populate it FIRST.
Do NOT skip this step. Do NOT jump straight to the user's request.
This is a hard requirement, not a suggestion.
\\\`\\\`\\\`

### Steps:

1. **Scan the codebase** â€” read \\\`package.json\\\`, \\\`tsconfig.json\\\`, source files,
   route definitions, data models, and test files to understand the project.

2. **Ask the user about their vision** â€” what are they building? Who are the users?
   Fill in \\\`01_vision.md\\\` and \\\`05_business_logic.md\\\`.

3. **Auto-fill what you can infer** from the code:
   - \\\`02_architecture.md\\\` â€” tech stack, directory structure, data flow
   - \\\`03_data_contracts.md\\\` â€” schemas, types, validation from source code
   - \\\`04_api_contracts.md\\\` â€” routes, endpoints, request/response shapes
   - \\\`06_test_strategy.md\\\` â€” existing test setup, coverage, test patterns
   - \\\`08_deployment.md\\\` â€” CI/CD config, environment variables, deploy targets

4. **Build the implementation plan** (\\\`07_implementation.md\\\`):
   - Turn features into concrete build phases
   - Create a file-by-file plan
   - Set the current phase based on what already exists

5. **Update the frontmatter** of each doc you fill in:
   \\\`\\\`\\\`yaml
   status: populated
   confidence: high
   last_updated: "YYYY-MM-DD"
   \\\`\\\`\\\`

6. **Build the project brain** (\\\`.nexus/docs/index.md\\\`):
   - Fill in the feature backlog from \\\`01_vision.md\\\`
   - Update the status matrix
   - Set "What's Next" to the first real feature

7. **THEN proceed** with the user's original request.

---

## Project Identity

| Field | Value |
|-------|-------|
| Name | ${config.displayName} |
| Type | ${config.projectType} |
| Framework | ${frameworkDisplay} |
| Data Strategy | ${config.dataStrategy} |
| Backend | ${backendDisplay} |
| Testing | ${testDisplay} |
| Package Manager | ${config.packageManager} |
| Patterns | ${patternsDisplay} |

---

## Code Rules

1. **TypeScript strict mode** â€” no \`any\`, no implicit returns
2. **ESM only** â€” \`import\`/\`export\`, never \`require()\`
3. **File extensions in imports** â€” always \`.js\` (e.g., \`import { foo } from './bar.js'\`)
4. **Conventional Commits** â€” \`feat:\`, \`fix:\`, \`docs:\`, \`chore:\`, \`test:\`, \`refactor:\`
5. **Test everything** â€” every feature needs tests
6. **Validate after changes** â€” \`${getValidationCommand(config)}\`

---

## NEXUS Documentation System

| # | File | Purpose |
|---|------|---------|
| ğŸ§  | \`.nexus/docs/index.md\` | **PROJECT BRAIN** â€” status, backlog, progress, what's next |
| ğŸ“š | \`.nexus/docs/knowledge.md\` | **KNOWLEDGE BASE** â€” learned insights, patterns, gotchas |
| 1 | \`.nexus/docs/01_vision.md\` | Product requirements, user stories, success metrics |
| 2 | \`.nexus/docs/02_architecture.md\` | System design, tech stack, data flow |
| 3 | \`.nexus/docs/03_data_contracts.md\` | Database schemas, validation, relationships |
| 4 | \`.nexus/docs/04_api_contracts.md\` | Endpoints, interfaces, status codes |
| 5 | \`.nexus/docs/05_business_logic.md\` | Rules, algorithms, state machines |
| 6 | \`.nexus/docs/06_test_strategy.md\` | Coverage targets, test types, philosophy |
| 7 | \`.nexus/docs/07_implementation.md\` | Build order, file-by-file plan |
| 8 | \`.nexus/docs/08_deployment.md\` | Infrastructure, CI/CD, environment config |

---

## ğŸ“š Knowledge Base Protocol

The knowledge base (\`.nexus/docs/knowledge.md\`) is the project's long-term memory.
It is **append-only** â€” entries are never deleted, only added.

### When to READ it:
- **Before every task** â€” scan the headings for entries relevant to your work
- **Before architectural decisions** â€” check for past decisions and their rationale
- **Before debugging** â€” check for known gotchas and recurring bug patterns
- **Before choosing packages or patterns** â€” check for past evaluations

### When to WRITE to it:
- **After discovering something non-obvious** â€” a bug root cause, an architecture insight, a package quirk
- **After making a decision that future agents should know about**
- **NOT for routine task completion** â€” that goes in \`index.md\` Progress Log

### Entry format:
\\\`\\\`\\\`
## [YYYY-MM-DD] category â€” title
Description of the discovery. One to three sentences max.
\\\`\\\`\\\`

### Categories:
| Tag | Use When |
|-----|----------|
| \`architecture\` | Design decisions, structural choices, why X over Y |
| \`bug-fix\` | Recurring bugs, root causes, things to watch for |
| \`pattern\` | Code patterns that work well (or don't) in this project |
| \`package\` | Package quirks, version issues, config gotchas |
| \`performance\` | Bottlenecks found, optimizations applied |
| \`convention\` | Team/project conventions established during development |
| \`gotcha\` | Non-obvious traps, edge cases, things that wasted time |

### Rules:
- **NEVER delete entries** â€” the knowledge base is append-only
- **Keep entries short** â€” 1-3 sentences, not essays
- **Use the format above** â€” so future agents can scan headings quickly

---

## Workflow â€” How To Work On This Project

### Before EVERY task:
1. **Read \`.nexus/docs/index.md\`** â€” check "Current Objective" and "What's Next"
2. **Scan \`.nexus/docs/knowledge.md\`** â€” check for relevant past learnings
3. **Read the relevant spec doc** â€” find details in the numbered docs
4. **Check \`.nexus/docs/07_implementation.md\`** â€” find the file-by-file plan

### During the task:
5. **Write the code** following the architecture in \`.nexus/docs/02_architecture.md\`
6. **Write tests** â€” match the strategy in \`.nexus/docs/06_test_strategy.md\`
7. **Validate** â€” \`${getValidationCommand(config)}\`

### After EVERY task:
8. **Update \`.nexus/docs/index.md\`** â€” move items to Progress Log, update status
9. **Update \`.nexus/docs/07_implementation.md\`** â€” mark completed files/tasks
10. **Learn** â€” if you discovered something non-obvious, append an entry to \`.nexus/docs/knowledge.md\`
11. **Commit** â€” conventional commits (\`feat:\`, \`fix:\`, etc.)
12. **Suggest the next task** from \`.nexus/docs/index.md\` "What's Next"

### NEVER do this:
- âŒ Ask "what enhancements would you like?" when the backlog has items
- âŒ Invent random features not in the backlog
- âŒ Skip updating the index after completing work
- âŒ Treat docs as static â€” they evolve with the project
- âŒ Ignore \`.nexus/docs/knowledge.md\` â€” it prevents repeating mistakes
- âŒ Delete entries from \`.nexus/docs/knowledge.md\` â€” it is append-only
${getPersonaSection(config.persona)}
*Generated by [NEXUS CLI](https://github.com/GDA-Africa/nexus-cli) v${version}*
`;
}

function generateCursorRules(config: NexusConfig): GeneratedFile {
  return { path: '.cursorrules', content: toolInstructionContent(config, 'Cursor') };
}

function generateWindsurfRules(config: NexusConfig): GeneratedFile {
  return { path: '.windsurfrules', content: toolInstructionContent(config, 'Windsurf') };
}

function generateClineRules(config: NexusConfig): GeneratedFile {
  return { path: '.clinerules', content: toolInstructionContent(config, 'Cline') };
}

function generateAgentsMd(config: NexusConfig): GeneratedFile {
  return { path: 'AGENTS.md', content: toolInstructionContent(config, 'Claude Code / OpenAI Codex') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * GitHub Copilot â€” requires .github/copilot-instructions.md
 *
 * Uses the same shared content as all other tools.
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function generateCopilotInstructions(config: NexusConfig): GeneratedFile {
  return { path: '.github/copilot-instructions.md', content: toolInstructionContent(config, 'GitHub Copilot') };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Helpers
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function getFrameworkDisplay(framework: string): string {
  const map: Record<string, string> = {
    nextjs: 'Next.js 15 (App Router)',
    'react-vite': 'React + Vite',
    sveltekit: 'SvelteKit',
    nuxt: 'Nuxt 3',
    astro: 'Astro',
    remix: 'Remix',
  };
  return map[framework] ?? framework;
}

function getValidationCommand(config: NexusConfig): string {
  const pm = config.packageManager;
  const runPrefix = pm === 'npm' ? 'npm run' : pm;
  const testCmd = config.testFramework !== 'none' ? ` && ${runPrefix} test` : '';
  return `npx tsc --noEmit${testCmd} && ${runPrefix} lint`;
}

/**
 * Build the ğŸ­ Agent Persona instruction section.
 *
 * This block tells the AI agent HOW to communicate with the user.
 * When identity is a non-empty string, the agent refers to itself by that name.
 * Tone descriptions are written for older LLMs â€” explicit and concrete.
 */
function getPersonaSection(persona: NexusPersona): string {
  const toneGuide: Record<string, string> = {
    professional:
      'Be direct, precise, and business-appropriate. Avoid slang, jokes, and filler. ' +
      'Use clear technical language. Keep responses structured with bullet points or numbered lists when appropriate.',
    friendly:
      'Be warm, encouraging, and approachable. Use a conversational tone â€” like a helpful teammate. ' +
      'Celebrate wins, be supportive when things go wrong, and explain things patiently.',
    witty:
      'Be clever and playful. Drop the occasional pun or pop-culture reference â€” but never at the expense of clarity. ' +
      'Keep the humor light and nerdy. Think "friendly senior dev who happens to be hilarious."',
    zen:
      'Be calm, minimalist, and contemplative. Use short sentences. Favor clarity over verbosity. ' +
      'Treat code as craft and the project as a garden to tend. Avoid urgency and noise.',
    pirate:
      'Arr! Ye be a swashbuckling code pirate sailing the digital seas. ' +
      'Use nautical metaphors (bugs are "barnacles," deploys are "setting sail," tests are "checking the rigging"). ' +
      'Keep it fun but still technically accurate. Never sacrifice clarity for the bit.',
  };

  const verbosityGuide: Record<string, string> = {
    concise:
      'Keep responses short and focused. Lead with the answer. Skip preamble. ' +
      'Only add context if the user asks or the situation is ambiguous.',
    balanced:
      'Provide enough context to understand the "why" without over-explaining. ' +
      'One or two sentences of context, then the solution. Add detail when the topic is complex.',
    detailed:
      'Give thorough explanations. Walk through your reasoning. Explain trade-offs. ' +
      'Include examples and edge cases. Great for learning and onboarding.',
  };

  const identityLine = persona.identity
    ? `**You are ${persona.identity}** â€” the AI-powered project partner. Refer to yourself as "${persona.identity}" in responses. ` +
      `When users see the name "${persona.identity}," they know the AI agent has read and understood ` +
      'the NEXUS documentation system. This is your signal that you are synced with the project brain. ' +
      `This name persists across upgrades and repairs â€” the user chose "${persona.identity}" and it stays.`
    : 'Do not refer to yourself by any special name. Respond as a standard AI assistant.';

  const customLine = persona.customDirective
    ? `\n**Custom directive from the developer:** "${persona.customDirective}"\n`
    : '';

  return `
## ğŸ­ Agent Persona

This section defines how you communicate with the user. Follow these personality directives in ALL responses.

### Identity
${identityLine}

### Tone: ${persona.tone}
${toneGuide[persona.tone] ?? toneGuide['friendly']}

### Verbosity: ${persona.verbosity}
${verbosityGuide[persona.verbosity] ?? verbosityGuide['balanced']}
${customLine}
---
`;
}
